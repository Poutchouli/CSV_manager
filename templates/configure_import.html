<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configure CSV Import</title>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.min.css">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f7f6; }
        .container { max-width: 1400px; margin: auto; padding: 25px; background-color: #fff; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1, h2 { text-align: center; color: #2c3e50; margin-bottom: 25px; }
        .file-selection { margin-bottom: 25px; text-align: center; }
        .file-selection button {
            background-color: #e9ecef;
            color: #333;
            border: 1px solid #ccc;
            padding: 10px 20px;
            margin: 0 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s ease;
        }
        .file-selection button.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        .file-selection button:hover:not(.active) {
            background-color: #d6e9f8;
        }

        .import-options-section { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 30px; }
        .option-group {
            flex: 1; /* Allow groups to grow */
            min-width: 280px; /* Minimum width for responsiveness */
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #fdfdfd;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .option-group h3 { margin-top: 0; color: #34495e; font-size: 1.2em; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        .option-item { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        input[type="text"], input[type="number"], select {
            width: calc(100% - 20px); /* Adjust for padding */
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
            box-sizing: border-box; /* Include padding in width */
        }
        input[type="checkbox"] { margin-right: 8px; }
        .radio-group { display: flex; flex-wrap: wrap; gap: 15px; }
        .radio-group label { display: flex; align-items: center; font-weight: normal; margin-bottom: 0; }
        .radio-group input[type="radio"] { margin-right: 5px; }
        .other-delimiter-input { width: 50px; margin-left: 5px; }

        .preview-section { margin-top: 30px; }
        .preview-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .preview-header h3 { margin: 0; color: #34495e; }
        #preview-table-container { max-height: 400px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #fdfdfd; }
        #preview-table { width: 100%; border-collapse: collapse; }
        #preview-table th, #preview-table td {
            padding: 10px;
            border: 1px solid #e9ecef;
            text-align: left;
            white-space: nowrap; /* Prevent wrapping in cells */
            overflow: hidden;
            text-overflow: ellipsis; /* Add ellipsis for overflow */
            max-width: 200px; /* Limit width of cells */
        }
        #preview-table th { background-color: #f2f2f2; font-weight: bold; position: sticky; top: 0; z-index: 1;} /* Sticky header */

        .action-buttons { text-align: center; margin-top: 30px; }
        .action-buttons button {
            background-color: #28a745;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.2s ease;
        }
        .action-buttons button:hover { background-color: #218838; }

        .error-message, .loading-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            margin-top: 15px;
            border: 1px solid #f5c6cb;
            display: none; /* Hidden by default */
        }
        .loading-message {
            background-color: #d1ecf1;
            color: #0c5460;
            border-color: #bee5eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Configure CSV Import</h1>
        <p style="text-align: center; color: #666;">Adjust the options below to ensure your CSV is parsed correctly. A live preview will update as you make changes.</p>

        <div class="file-selection">
            {% for file_obj in files %}
                <button type="button" class="select-file-btn {% if loop.first %}active{% endif %}"
                        data-file-key="{{ file_obj.key }}" data-file-name="{{ file_obj.name }}">
                    {{ file_obj.name }}
                </button>
            {% endfor %}
        </div>

        <div class="import-options-section">
            <div class="option-group">
                <h3>General Options</h3>
                <div class="option-item">
                    <label for="encoding">Character Set:</label>
                    <select id="encoding">
                        <option value="utf-8" {% if default_options.encoding == 'utf-8' %}selected{% endif %}>Unicode (UTF-8)</option>
                        <option value="iso-8859-1">Western European (ISO-8859-1)</option>
                        <option value="latin1">Latin-1 (ISO-8859-1)</option>
                        <option value="cp1252">Windows-1252</option>
                    </select>
                </div>
                <div class="option-item">
                    <label for="skip-rows">Start Import From Row:</label>
                    <input type="number" id="skip-rows" min="0" value="{{ default_options.skip_rows }}">
                </div>
                <div class="option-item">
                    <input type="checkbox" id="has-header" {% if default_options.has_header %}checked{% endif %}>
                    <label for="has-header" style="display: inline-block;">First row is header</label>
                </div>
            </div>

            <div class="option-group">
                <h3>Delimiter Options</h3>
                <div class="option-item radio-group">
                    <label><input type="radio" name="delimiter" value="," {% if default_options.delimiter == ',' %}checked{% endif %}> Comma</label>
                    <label><input type="radio" name="delimiter" value=";" {% if default_options.delimiter == ';' %}checked{% endif %}> Semicolon</label>
                    <label><input type="radio" name="delimiter" value="\t"> Tabulation</label>
                    <label><input type="radio" name="delimiter" value="space"> Space</label>
                    <label>
                        <input type="radio" name="delimiter" value="other" id="other-delimiter-radio"> Other:
                        <input type="text" id="other-delimiter-input" class="other-delimiter-input" maxlength="1" disabled>
                    </label>
                </div>
                <div class="option-item">
                    <label for="quotechar">Text Qualifier (e.g., "):</label>
                    <input type="text" id="quotechar" maxlength="1" value="{{ default_options.quotechar }}">
                </div>
            </div>
        </div>

        <div class="preview-section">
            <div class="preview-header">
                <h3>Preview: <span id="current-preview-file-name"></span></h3>
                <span id="preview-status" class="loading-message">Loading preview...</span>
                <span id="preview-error" class="error-message"></span>
            </div>
            <div id="preview-table-container">
                <table id="preview-table">
                    <thead>
                        </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>

        <div class="action-buttons">
            <button id="import-all-btn">Import & Clean Selected CSV(s)</button>
        </div>
    </div>

    <script type="text/javascript" src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
        $(document).ready(function() {
            const sessionId = "{{ session_id }}";
            let currentFileKey = $('.select-file-btn.active').data('file-key');

            // Function to get current parsing options
            function getParsingOptions() {
                let delimiter = $('input[name="delimiter"]:checked').val();
                if (delimiter === 'other') {
                    delimiter = $('#other-delimiter-input').val();
                } else if (delimiter === 'space') {
                    delimiter = ' '; // Pandas expects ' ' for single space delimiter
                }
                
                return {
                    session_id: sessionId,
                    file_key: currentFileKey,
                    encoding: $('#encoding').val(),
                    delimiter: delimiter,
                    quotechar: $('#quotechar').val(),
                    has_header: $('#has-header').is(':checked'),
                    skip_rows: $('#skip-rows').val()
                };
            }

            // Function to fetch and render preview
            function fetchAndRenderPreview() {
                const options = getParsingOptions();
                $('#preview-status').text('Loading preview...').show();
                $('#preview-error').hide();
                $('#preview-table thead').empty();
                $('#preview-table tbody').empty();

                $.ajax({
                    url: '/preview_csv',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(options),
                    success: function(response) {
                        $('#preview-status').hide();
                        if (response.error) {
                            $('#preview-error').text('Preview Error: ' + response.error).show();
                        } else {
                            renderPreviewTable(response.headers, response.rows);
                        }
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        $('#preview-status').hide();
                        $('#preview-error').text('AJAX Error: Could not load preview. ' + errorThrown).show();
                        console.error('Error fetching preview:', textStatus, errorThrown, jqXHR.responseText);
                    }
                });
            }

            // Function to render the preview table
            function renderPreviewTable(headers, rows) {
                let headerHtml = '<tr>';
                headers.forEach(header => {
                    headerHtml += `<th>${escapeHtml(header)}</th>`;
                });
                headerHtml += '</tr>';
                $('#preview-table thead').html(headerHtml);

                let bodyHtml = '';
                rows.forEach(row => {
                    bodyHtml += '<tr>';
                    row.forEach(cell => {
                        bodyHtml += `<td>${escapeHtml(cell)}</td>`;
                    });
                    bodyHtml += '</tr>';
                });
                $('#preview-table tbody').html(bodyHtml);
            }

            // Simple HTML escaping function
            function escapeHtml(text) {
                if (text === null || typeof text === 'undefined') {
                    return '';
                }
                return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
            }

            // Event Listeners for file selection
            $('.select-file-btn').on('click', function() {
                $('.select-file-btn').removeClass('active');
                $(this).addClass('active');
                currentFileKey = $(this).data('file-key');
                $('#current-preview-file-name').text($(this).data('file-name'));
                fetchAndRenderPreview(); // Re-fetch preview for the selected file
            });

            // Event Listeners for option changes (debounce for performance)
            let debounceTimer;
            $('input[type="text"], input[type="number"], select, input[type="radio"], input[type="checkbox"]').on('change keyup', function() {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(fetchAndRenderPreview, 500); // Wait 500ms before fetching
            });

            // Handle 'Other' delimiter input enabling/disabling
            $('#other-delimiter-radio').on('change', function() {
                $('#other-delimiter-input').prop('disabled', !this.checked);
            });
            $('input[name="delimiter"]').on('change', function() {
                if (this.value !== 'other') {
                    $('#other-delimiter-input').prop('disabled', true);
                }
            });
            // Initial state for 'Other' delimiter
            if ($('#other-delimiter-radio').is(':checked')) {
                $('#other-delimiter-input').prop('disabled', false);
            }


            // Handle Import All button click
            $('#import-all-btn').on('click', function() {
                // Collect options for all uploaded files
                const filesToImport = [];
                $('.select-file-btn').each(function() {
                    const fileKey = $(this).data('file-key');
                    // For now, we'll assume the currently displayed options apply to all files.
                    // In a more complex scenario, user might configure each file separately.
                    // Or, we send current options + file_key for each, and Flask processes them sequentially.
                    filesToImport.push({
                        file_key: fileKey,
                        options: getParsingOptions() // This gets options for the *currently selected* file.
                                                    // If options are file-specific, need to store/retrieve them.
                    });
                });
                
                // For simplicity now, let's just use the current options for the selected file,
                // and assume for *this* step that options applied to one file
                // are intended for all. If both files are present, we'll send both keys.
                // A better approach would be to have a hidden input or JS object per file storing its config.
                
                // Let's modify the final import to just send the session_id, and let Flask
                // re-read the raw files from session and apply the _default_ parsing options
                // (or the ones stored if we implement file-specific option storage).
                // For now, just send the session_id to trigger the final cleaning/display.
                
                // New Approach for 'Import All': Trigger the final cleaning and display route.
                // We'll create a new route '/final_import' that takes the session_id.
                // This route will iterate through raw_uploaded_file_paths, apply a default (or last used) config,
                // and then perform the cleaning, before redirecting to display_csv.
                window.location.href = `/final_import/${sessionId}`;
            });

            // Initial load: set active file name and fetch preview for the first file
            $('#current-preview-file-name').text($('.select-file-btn.active').data('file-name'));
            fetchAndRenderPreview();
        });
    </script>
</body>
</html>